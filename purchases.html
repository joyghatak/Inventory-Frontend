<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchases | Inventory System</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">

  <aside class="w-64 bg-blue-700 text-white flex flex-col">
    <div class="p-4 text-2xl font-bold border-b border-blue-600">Inventory App</div>
    <nav class="flex-1 p-4 space-y-2 text-sm">
      <a href="dashboard.html" class="block p-2 hover:bg-blue-600 rounded">üè† Dashboard</a>
      <a href="products.html" class="block p-2 hover:bg-blue-600 rounded">üì¶ Products</a>
      <a href="suppliers.html" class="block p-2 hover:bg-blue-600 rounded">üöö Suppliers</a>
      <a href="customers.html" class="block p-2 hover:bg-blue-600 rounded">üë§ Customers</a>
      <a href="purchases.html" class="block p-2 bg-blue-600 rounded">üì• Purchases</a>
      <a href="sales.html" class="block p-2 hover:bg-blue-600 rounded">üí∞ Sales</a>
      <a href="reports.html" class="block p-2 hover:bg-blue-600 rounded">üìä Reports</a>
      <a href="settings.html" class="block p-2 hover:bg-blue-600 rounded">‚öôÔ∏è Settings</a>
      <a href="login.html" class="block p-2 text-red-300 hover:bg-red-600 rounded">üö™ Logout</a>
    </nav>
  </aside>

  <main class="flex-1 p-6 overflow-auto">
    <h1 class="text-2xl font-bold mb-6">Purchases</h1>

    <div class="bg-white p-4 rounded-xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-4">Record New Purchase (Stock In)</h2>
      <form id="recordPurchaseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="text" id="productInput" placeholder="Product ID" required class="border rounded-lg px-3 py-2">
        <input type="text" id="supplierInput" placeholder="Supplier ID" required class="border rounded-lg px-3 py-2">
        <input type="number" id="quantityInput" placeholder="Quantity" required min="1" class="border rounded-lg px-3 py-2">
        <input type="number" id="totalCostInput" placeholder="Total Cost" required min="0" class="border rounded-lg px-3 py-2">
        <button type="submit" class="bg-blue-600 text-white rounded-lg py-2 hover:bg-blue-700 col-span-1 md:col-span-4">Record Purchase</button>
      </form>
    </div>

    <div class="bg-white p-4 rounded-xl shadow">
      <h2 class="text-lg font-semibold mb-4">Purchase Records</h2>
      <table class="w-full border-collapse text-left">
        <thead>
          <tr class="bg-gray-100 text-gray-600">
            <th class="p-2">Date</th>
            <th class="p-2">Product</th>
            <th class="p-2">Supplier</th>
            <th class="p-2">Qty</th>
            <th class="p-2">Cost</th>
          </tr>
        </thead>
        <tbody id="purchaseTableBody">
          </tbody>
      </table>
      <p id="loadingStatus" class="mt-4 text-gray-500">Loading purchase records...</p>
    </div>
  </main>
</div>

<script>
  // ** IMPORTANT: Ensure this port matches your running backend port (5500)! **
  const API_BASE_URL = 'http://localhost:5500/api/purchases';
  const tableBody = document.getElementById('purchaseTableBody');
  const loadingStatus = document.getElementById('loadingStatus');

  // --- Utility: Convert Date to readable format ---
  const formatDate = (dateString) => {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
  };
  const formatCurrency = (amount) => `‚Çπ${parseFloat(amount).toLocaleString('en-IN')}`;

  // --- 1. FETCH AND RENDER PURCHASE DATA ---
  async function fetchPurchases() {
    try {
      const response = await fetch(API_BASE_URL);
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      const purchases = await response.json();
      renderPurchases(purchases);
    } catch (error) {
      console.error('Error fetching purchases:', error);
      loadingStatus.textContent = `Error loading purchases: ${error.message}. Is the backend running on ${API_BASE_URL}?`;
    }
  }

  function renderPurchases(purchases) {
    tableBody.innerHTML = ''; 
    loadingStatus.style.display = 'none';

    if (purchases.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" class="p-2 text-center text-gray-500">No purchase records found.</td></tr>';
      return;
    }

    purchases.forEach(purchase => {
      const row = tableBody.insertRow();
      row.className = 'border-t';
      
      row.insertCell().textContent = formatDate(purchase.date);
      row.insertCell().textContent = purchase.product_id ? purchase.product_id.name : 'Unknown Product';
      row.insertCell().textContent = purchase.supplier_id ? purchase.supplier_id.name : 'Unknown Supplier';
      row.insertCell().textContent = purchase.quantity;
      row.insertCell().textContent = formatCurrency(purchase.total_cost);
    });
  }

  // --- 2. HANDLE FORM SUBMISSION (RECORD NEW PURCHASE) ---
  document.getElementById('recordPurchaseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // NOTE: The user must enter the MongoDB ID here.
    const product_id = document.getElementById('productInput').value;
    const supplier_id = document.getElementById('supplierInput').value;
    const quantity = document.getElementById('quantityInput').value;
    const total_cost = document.getElementById('totalCostInput').value;

    const newPurchase = { 
        product_id, 
        supplier_id, 
        quantity: parseInt(quantity), 
        total_cost: parseFloat(total_cost)
    };

    try {
      const response = await fetch(API_BASE_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(newPurchase),
      });

      const responseData = await response.json();

      if (!response.ok) {
        throw new Error(responseData.message || 'Failed to record purchase. Check input IDs.');
      }

      document.getElementById('recordPurchaseForm').reset();
      fetchPurchases(); 
      alert('Purchase recorded and stock incremented successfully!');

    } catch (error) {
      console.error('Error recording purchase:', error);
      alert('Error: ' + error.message);
    }
  });

  // Load data when the page opens
  fetchPurchases();
</script>
</body>
</html>